"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _path=_interopRequireDefault(require("path")),_sharedUtils=require("@hap-toolkit/shared-utils"),_exp=_interopRequireDefault(require("./exp")),_style=_interopRequireDefault(require("../style")),_utils=require("../utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const extList=[".mix",".ux",".vue"],richtextType=["mix","ux"],REG_TAG_DATA_ATTR=/^data-\w+/,REG_CLASS_VALUE=/[^{}\s]+((?=\s)|$)|[^{}\s]*\{\{[^]*?\}\}[^\s]*/g,RESERVED_TAGS=Object.keys(_utils.FRAG_TYPE).map(e=>_utils.FRAG_TYPE[e]),tagCommon={events:["click","focus","blur","longpress","appear","disappear","swipe","touchstart","touchmove","touchend","touchcancel","resize"],attrs:{id:{},style:{},class:{},disabled:{enum:["false","true"]},if:{def:"true"},elif:{def:"true"},else:{},for:{},tid:{},show:{def:"true"},"aria-label":{},"aria-unfocusable":{enum:["false","true"]},forcedark:{enum:["true","false"]}},children:["block","slot","component"],parents:["block"]},tagNatives={div:{supportCard:!0},a:{supportCard:!0,textContent:!0,children:["span"],attrs:{visited:{enum:["false","true"]},href:{}}},text:{supportCard:!0,textContent:!0,children:["a","span"],attrs:{type:{enum:["text","html"]}}},span:{supportCard:!0,textContent:!0,excludeRoot:!0,children:["span"],parents:["text","a","span"],attrs:{extendCommon:!1,id:{},style:{},class:{},for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},label:{supportCard:!0,textContent:!0,atomic:!0,attrs:{target:{}}},image:{events:["complete","error"],empty:!0,supportCard:!0,selfClosing:!0,alias:["img"],atomic:!0,attrs:{src:{},alt:{},enablenightmode:{enum:["true","false"]}}},slider:{selfClosing:!0,atomic:!0,attrs:{enabled:{enum:["true","false"]},min:{def:0},max:{def:100},step:{def:1},value:{def:0}},events:["change"]},web:{atomic:!0,events:["pagestart","pagefinish","titlereceive","error","message","progress"],attrs:{src:{},trustedurl:{},allowthirdpartycookies:{enum:["false","true"]},enablenightmode:{enum:["true","false"]},showloadingdialog:{enum:["true","false"]},supportzoom:{enum:["false","true"]}}},list:{children:["list-item"],attrs:{scrollpage:{enum:["false","true"]}},events:["scroll","scrollbottom","scrolltop","scrollend","scrolltouchup"]},"list-item":{excludeRoot:!0,parents:["list"],attrs:{type:{required:!0}}},block:{excludeRoot:!0,supportCard:!0,attrs:{extendCommon:!1,for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},component:{excludeRoot:!0,attrs:{extendCommon:!1,is:{required:!0},for:{},tid:{},if:{def:"true"},elif:{def:"true"},else:{}}},slot:{excludeRoot:!0,attrs:{name:{def:"default"},extendCommon:!1,content:{}}},input:{supportCard:!0,selfClosing:!0,atomic:!0,empty:!0,attrs:{type:{enum:["text","button","checkbox","radio","email","date","time","number","password","tel"]},autocomplete:{enum:["on","off"]},enterkeytype:{enum:["default","next","go","done","send","search"]},maxlength:{},checked:{enum:["false","true"]},name:{},value:{},placeholder:{}},events:["change","enterkeyclick","selectionchange"]},button:{supportCard:!0,textContent:!0,atomic:!0},refresh:{attrs:{offset:{def:"132px"},refreshing:{enum:["false","true"]},type:{enum:["auto","pulldown"]}},events:["refresh"]},swiper:{attrs:{index:{def:0},autoplay:{enum:["false","true"]},interval:{def:3e3},indicator:{enum:["true","false"]},loop:{enum:["true","false"]},duration:{},vertical:{enum:["false","true"]},previousmargin:{def:"0px"},nextmargin:{def:"0px"}},events:["change"]},progress:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{percent:{def:0},type:{enum:["horizontal","circular"]}}},picker:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{type:{required:!0,enum:["text","date","time","multi-text"]},start:{def:"1970-1-1"},end:{def:"2100-12-31"},range:{},selected:{},value:{}},events:["change","columnchange","cancel"]},switch:{supportCard:!0,selfClosing:!0,atomic:!0,attrs:{checked:{enum:["false","true"]}},events:["change"]},textarea:{supportCard:!0,atomic:!0,textContent:!0,attrs:{placeholder:{},maxlength:{}},events:["change","selectionchange","linechange"]},video:{atomic:!0,attrs:{src:{},muted:{enum:["false","true"]},autoplay:{enum:["false","true"]},controls:{enum:["true","false"]},poster:{},orientation:{enum:["landscape","portrait"]},titlebar:{enum:["true","false"]},title:{}},events:["prepared","start","pause","finish","error","seeking","seeked","timeupdate","fullscreenchange"]},camera:{atomic:!0,selfClosing:!0,attrs:{deviceposition:{enum:["back","front"]},flash:{enum:["auto","on","off","torch"]}},events:["error"]},map:{children:["custommarker"],attrs:{latitude:{},longitude:{},coordtype:{},scale:{def:0},rotate:{def:0},markers:{},showmylocation:{enum:["true","false"]},polylines:{},polygons:{},circles:{},controls:{},groundoverlays:{},includepoints:{},heatmaplayer:{},showcompass:{enum:["true","false"]},enableoverlooking:{enum:["false","true"]},enablezoom:{enum:["true","false"]},enablescroll:{enum:["true","false"]},enablerotate:{enum:["true","false"]},showscale:{enum:["false","true"]},showzoom:{enum:["false","true"]}},events:["loaded","regionchange","tap","markertap","callouttap","controltap","poitap"]},custommarker:{parents:["map"],attrs:{custommarkerattr:{}}},canvas:{atomic:!0},stack:{supportCard:!0,events:["fullscreenchange"]},richtext:{textContent:!0,atomic:!0,attrs:{type:{required:!0,enum:["html"].concat(richtextType)}},events:["start","complete"]},tabs:{children:["tab-bar","tab-content"],attrs:{index:{def:0}},events:["change"]},"tab-content":{parents:["tabs"],attrs:{scrollable:{enum:["true","false"]}}},"tab-bar":{parents:["tabs"],attrs:{mode:{enum:["fixed","scrollable"]}}},popup:{supportCard:!0,children:["text"],attrs:{target:{required:!0},placement:{enum:["left","top","right","bottom","topLeft","topRight","bottomLeft","bottomRight"],def:"bottom"}},events:["visibilitychange"]},rating:{supportCard:!0,atomic:!0,attrs:{numstars:{def:"5"},rating:{def:"0"},stepsize:{def:"0.5"},indicator:{enum:["false","true"]}},events:["change"]},select:{supportCard:!0,children:["option"],events:["change"],excludeRoot:!0},option:{supportCard:!0,parents:["select"],atomic:!0,textContent:!0,attrs:{selected:{def:!1},value:{}},excludeRoot:!0},marquee:{supportCard:!0,textContent:!0,atomic:!0,attrs:{scrollamount:{def:6},loop:{def:-1},direction:{enum:["left","right"]}},events:["bounce","finish","start"]}},tagReserved=[];let tagComponents=[];const tagNativeKeys=Object.keys(tagNatives),tagAliasMap={},tagAttrMap={},tagEnumAttrMap={},tagDefaultAttrMap={},tagRequireAttrMap={},tagAtomics=[],tagTextCotent=[],tagChildrenMap={},tagParentsMap={},tagEventsMap={},tagNotRoot=[];function checkTagName(e,t,a={}){const s=t.result,n=t.log,l=_path.default.extname(a.filePath);let o=e.tagName;const r=e.childNodes||[],i=e.__location||{};tagComponents=a.importNames||[],tagAliasMap[o]&&("img"!==o&&n.push({line:i.line||1,column:i.col||1,reason:"NOTE: 组件名 `"+o+"` 自动转换为 `"+tagAliasMap[o]+"`"}),o=tagAliasMap[o]),s.type=o,RESERVED_TAGS.indexOf(o)>=0?n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件名 `"+o+"` 是系统保留的组件名, 请修改"}):hasTagDefined(o)||n.push({line:i.line||1,column:i.col||1,reason:`WARN: 未识别的标签名 '${o}'，如果是自定义组件，请确认已经引入`}),a.uxType===_utils.ENTRY_TYPE.CARD&&tagNatives[o]&&!tagNatives[o].supportCard&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 卡片不支持组件名 `"+o+"`, 请修改"}),e._isroot&&tagNotRoot.indexOf(o)>=0&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 不能作为根组件"}),tagAtomics.indexOf(o)>=0&&(tagTextCotent.indexOf(o)<0?r.length>0&&r.every(e=>"#text"===e.nodeName||(n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 是原子类型，不应该有子节点"}),!1)):(r.length>1||r[0]&&"#text"!==r[0].nodeName)&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 只能有一个文字子节点"})),s.attr=s.attr||{};const u=e.attrs||[],c=[];if(u.forEach((function(e){c.push(e.name.toLowerCase())})),tagDefaultAttrMap[o]&&Object.keys(tagDefaultAttrMap[o]).forEach(t=>{const s=c.indexOf(t);s>=0&&""===u[s].value?(u[s].value=tagDefaultAttrMap[o][t],n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 属性 `"+t+"` 值为空, 默认设置为缺省值 `"+tagDefaultAttrMap[o][t]+"`"})):"slot"===o&&s<0&&(e.attrs.push({name:t,value:tagDefaultAttrMap[o][t]}),_sharedUtils.colorconsole.warn(`标签${o}的属性 \`${t}\` 值为空, 默认设置为缺省值 \`${tagDefaultAttrMap[o][t]}\` ${a.filePath}@${i.line||1},${i.col||1}`))}),e._isroot){const e=["for","if","elif","else","show"];c.forEach(t=>{e.indexOf(t)>=0&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 根节点 `"+o+"` 不能使用属性 `"+t+"`"})})}if(tagRequireAttrMap[o]&&tagRequireAttrMap[o].forEach(e=>{c.indexOf(e)<0&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 没有定义属性 `"+e+"`"})}),tagEnumAttrMap[o]&&Object.keys(tagEnumAttrMap[o]).forEach(e=>{const t=c.indexOf(e);if(t>=0){const a=u[t].value;if(!_exp.default.isExpr(a)){const s=tagEnumAttrMap[o][e];s.indexOf(a)<0&&(u[t].value=s[0],n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 属性 `"+e+"` 的值 `"+a+"`非法, 默认设置为缺省值 `"+s[0]+"`"}))}}}),tagAttrMap[o]&&"component"!==o&&c.forEach(e=>{if(!e.match(/^(on|@)/)){if(l.indexOf(extList[2])>=-1&&/^(:|v-|key|ref|is|slot|slot-scope)/.test(e))return;const t=checkDataAttr(e),a=Object.prototype.hasOwnProperty.call(tagAttrMap[o],e);t||a||n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 不支持属性 `"+e+"`，支持的属性有 ["+Object.keys(tagAttrMap[o]).join(", ")+"]"})}}),tagEventsMap[o]&&"component"!==o){const e=tagEventsMap[o];c.forEach(t=>{if(t.match(/^(on|@)/)){const s=t.replace(/^(on|@)/,""),l=["appear","disappear","swipe"];a.uxType===_utils.ENTRY_TYPE.CARD&&l.indexOf(s.toLowerCase())>-1&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 卡片组件 `"+o+"` 不支持事件 `"+s+"`"}),e.indexOf(s.toLowerCase())<0&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 不支持事件 `"+s+"`"})}})}if(r.length>0){const e=new Set;r.forEach(t=>{if(isReservedTag(o)&&isReservedTag(t.nodeName)){const s=tagParentsMap[t.nodeName],l=tagChildrenMap[o];if("slot"===t.nodeName){let s=t.parentNode;for(;s;){if("slot"===s.tagName){_sharedUtils.colorconsole.warn(`slot标签内不应该嵌套slot ${a.filePath}@${i.line||1},${i.col||1}`);break}s=s.parentNode}const n={};t.attrs.map(e=>{n[e.name]=e.value}),n.hasOwnProperty("name")?/\{\{\s*[\w$]+\s*\}\}/.test(n.name)&&_sharedUtils.colorconsole.warn(`标签${t.nodeName}的name属性暂时不支持动态绑定 ${a.filePath}@${i.line||1},${i.col||1}`):n.name="default",e.has(n.name)?_sharedUtils.colorconsole.warn(`标签${o}内存在name为 \`${n.name}\` 重复slot ${a.filePath}@${i.line||1},${i.col||1}`):e.add(n.name)}(s&&s.indexOf(o)<0||l&&l.indexOf(t.nodeName)<0)&&n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 不支持子组件 `"+t.nodeName+"`"})}})}isSupportedSelfClosing(o)||!i.startTag||i.endTag||n.push({line:i.line||1,column:i.col||1,reason:"ERROR: 组件 `"+o+"` 缺少闭合标签，请检查"}),"list-item"===o&&hasIfOrFor(r)&&n.push({line:i.line||1,column:i.col||1,reason:"WARN: `list-item` 内部需谨慎使用指令 if 或 for，相同 type 属性的 list-item， DOM 结构必须完全相同`"})}function checkId(e,t){e&&(t.result.id=_exp.default.isExpr(e)?(0,_exp.default)(e):e)}function checkDataAttr(e){return REG_TAG_DATA_ATTR.test(e)}function checkBuild(e,t){e&&(t.result.append="tree"===e?"tree":"single")}function checkClass(className,output){let hasBinding,classList=[];if(className=className.trim(),className){let start=0,end=0;const segs=[],matched=className.match(REG_CLASS_VALUE);if(matched){let e;matched.forEach(t=>{end=className.indexOf(t,start),e=className.slice(start,end),e.length&&segs.push(e),segs.push(t),start+=e.length+t.length})}if(segs.push(className.slice(start)),classList=segs.reduce((e,t)=>_exp.default.isExpr(t)?(hasBinding=!0,e.push((0,_exp.default)(t,!1)),e):e.concat(t.split(/\s+/g).filter(e=>e).map(e=>`'${e}'`)),[]),classList=classList.filter(e=>e.trim()),hasBinding){const code="(function () {return ["+classList.join(", ")+"]})";try{output.result.classList=eval(code)}catch(e){throw e.isExpressionError=!0,e.expression=className,e}}else output.result.classList=classList.map(e=>e.slice(1,-1))}}function checkStyle(e,t,a,s){let n={};const l=t.log;if(e){if(_exp.default.singleExpr(e)){const s=_exp.default.removeExprffix(e);return _exp.default.isExpr(s)?l.push({line:a.line||1,column:a.col||1,reason:"ERROR: style 属性不能嵌套多层{{}}"}):n=(0,_exp.default)(e),void(t.result.style=n)}if(e.split(";").forEach((function(e){let t,o,r,i=e.trim().split(":");i.length>2&&(i[1]=i.slice(1).join(":"),i=i.slice(0,2)),2===i.length&&(t=i[0].trim(),t=(0,_utils.hyphenedToCamelCase)(t),o=i[1].trim(),o=(0,_exp.default)(o),r=_style.default.validateDelaration(t,o,s),o=r.value,o.forEach(e=>{((0,_utils.isValidValue)(e.v)||"function"==typeof e.v)&&(n[e.n]=e.v)}),r.log&&l.push({line:a.line||1,column:a.col||1,reason:r.log.reason}))})),"object"==typeof n)for(let e in n)_style.default.shouldAddToDependency(e,n[e])&&t.depFiles.push(n[e]);t.result.style=n}}function checkIs(e,t,a){const s=t.log;e?(e=_exp.default.addExprffix(e),t.result.is=(0,_exp.default)(e)):s.push({line:a.line||1,column:a.col||1,reason:"WARNING: is 属性为空"})}function checkIf(e,t,a,s,n){const l=t.log;e?(e=_exp.default.addExprffix(e),a?e="{{"+buildConditionExp(n)+"}}":(n.length>0&&(n.length=0),n.push(`${e.substr(2,e.length-4)}`)),t.result.shown=(0,_exp.default)(e)):a||l.push({line:s.line||1,column:s.col||1,reason:"WARNING: if 属性为空"})}function checkElse(e,t,a,s){checkIf(e,t,!0,a,s),s.length=0}function checkElif(e,t,a,s,n){const l=a.log;let o=t;return e?(e=_exp.default.addExprffix(e),t=_exp.default.addExprffix(t),o="{{("+e.substr(2,e.length-4)+") && "+buildConditionExp(n)+"}}",a.result.shown=(0,_exp.default)(o),n.push(`${e.substr(2,e.length-4)}`)):l.push({line:s.line||1,column:s.col||1,reason:"WARNING: Elif 属性为空"}),o}function checkFor(e,t,a){const s=t.log;if(e){let a,s;const n=(e=_exp.default.removeExprffix(e)).match(/(.*) (?:in) (.*)/);if(n){const t=n[1].match(/\((.*),(.*)\)/);t?(a=t[1].trim(),s=t[2].trim()):s=n[1].trim(),e=n[2]}let l;e="{{"+e+"}}",a||s?(l={exp:(0,_exp.default)(e)},a&&(l.key=a),s&&(l.value=s)):l=(0,_exp.default)(e),t.result.repeat=l}else s.push({line:a.line||1,column:a.col||1,reason:"WARNING: for 属性为空"})}function checkEvent(name,value,output){const originValue=value,eventName=name.replace(/^(on|@)/,"");if(eventName&&value){value=_exp.default.removeExprffix(value);const paramsMatch=value.match(/(.*)\((.*)\)/);if(paramsMatch){const funcName=paramsMatch[1];let params=paramsMatch[2];params?(params=params.split(/\s*,\s*/),-1===params.indexOf("evt")&&(params[params.length]="evt")):params=["evt"],value="{{"+funcName+"("+params.join(",")+")}}";try{value=eval("(function (evt) {"+(0,_exp.default)(value,!1).replace("this.evt","evt")+"})")}catch(e){throw e.isExpressionError=!0,e.expression=originValue,e}}output.result.events=output.result.events||{},output.result.events[eventName]=value}}function checkAttr(e,t,a,s,n,l){if(e&&(0,_utils.isValidValue)(t)){if(shouldConvertPath(e,t,s)){(0,_utils.fileExists)(t,l.filePath)||a.log.push({line:n.line,column:n.column,reason:"WARNING: "+s+" 属性 "+e+" 的值 "+t+" 下不存在对应的文件资源"}),t=(0,_utils.resolvePath)(t,l.filePath),a.depFiles.push(t)}a.result.attr=a.result.attr||{},a.result.attr[(0,_utils.hyphenedToCamelCase)(e)]=(0,_exp.default)(t),"value"===e&&"text"===s&&a.log.push({line:n.line,column:n.column,reason:"WARNING: `value` 应该写在<text>标签中"})}}function shouldConvertPath(e,t,a){return!(!("src"===e&&t&&["img","video"].indexOf(a)>-1)||/^(data:|http|{{)/.test(t))}function isReservedTag(e){return tagReserved.indexOf(e)>-1}function isTextContentAomtic(e){return tagTextCotent.indexOf(e)>-1&&tagAtomics.indexOf(e)>-1}function isSupportSpan(e){if(e&&"string"==typeof e)return tagChildrenMap[e]&&tagChildrenMap[e].indexOf("span")>-1}function getTagChildren(e){if(e&&"string"==typeof e)return tagChildrenMap[e]||[]}function isSupportedSelfClosing(e){if(e&&"string"==typeof e)return e=tagAliasMap[e]||e,tagNatives[e]&&!!tagNatives[e].selfClosing}function hasTagDefined(e){return tagNativeKeys.indexOf(e)>-1||tagComponents.indexOf(e)>-1}function isEmptyElement(e){return e=tagAliasMap[e]||e,tagNatives[e]&&!0===tagNatives[e].empty}function buildConditionExp(e){return e.map(e=>`!(${e})`).join(" && ")}function hasIfOrFor(e){let t=!1;return e.find(e=>{return(e.attrs||[]).findIndex(e=>["for","if"].indexOf(e.name)>-1)>-1?(t=!0,t):Array.isArray(e.childNodes)?(t=hasIfOrFor(e.childNodes),t):void 0}),t}tagNativeKeys.forEach((function(e){tagReserved.push(e);const t=tagNatives[e];t.atomic&&tagAtomics.push(e),t.textContent&&tagTextCotent.push(e),t.alias&&t.alias.length&&t.alias.forEach((function(t){tagAliasMap[t]=e})),!0===t.excludeRoot&&tagNotRoot.push(e);let a=(0,_utils.extend)({},t.attrs);const s={},n={},l=[];t.attrs&&!1===t.attrs.extendCommon||(a=(0,_utils.extend)(a,tagCommon.attrs)),"extendCommon"in a&&delete a.extendCommon,Object.keys(a).forEach((function(e){const t=a[e];t.enum&&t.enum.length>0&&(s[e]=t.enum,n[e]=t.enum[0]),t.def&&(n[e]=t.def),!0===t.required&&l.push(e)})),tagAttrMap[e]=a,tagEnumAttrMap[e]=s,tagDefaultAttrMap[e]=n,tagRequireAttrMap[e]=l,tagChildrenMap[e]=t.children?(0,_utils.merge)([],tagCommon.children,t.children):null,tagParentsMap[e]=t.parents?(0,_utils.merge)([],tagCommon.parents,t.parents):null,tagEventsMap[e]=(0,_utils.merge)([],tagCommon.events,t.events)}));var _default={checkTagName:checkTagName,checkId:checkId,checkClass:checkClass,checkStyle:checkStyle,checkIs:checkIs,checkIf:checkIf,checkElse:checkElse,checkElif:checkElif,checkFor:checkFor,checkEvent:checkEvent,checkAttr:checkAttr,checkBuild:checkBuild,isReservedTag:isReservedTag,isTextContentAomtic:isTextContentAomtic,isSupportSpan:isSupportSpan,getTagChildren:getTagChildren,isSupportedSelfClosing:isSupportedSelfClosing,isEmptyElement:isEmptyElement};exports.default=_default;
//# sourceMappingURL=validator.js.map
